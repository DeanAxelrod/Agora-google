<!DOCTYPE html>
<html>
<head>
    <title>Agora Voice Recorder</title>
    <script src="https://cdn.agora.io/sdk/release/AgoraRTCSDK-3.6.9.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>
</head>
<body>
    <h1>Agora Voice Recorder</h1>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <p id="status">Status: Idle</p>

    <script>
        const appId = "25336bcd01664c70870804ba0b7e1b30"; // Replace with your Agora App ID
        const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        let localStream;

        // Teachable Machine Model URL
        const modelURL = "https://deanaxelrod.github.io/Google-TM/model.json"; // Replace with your Teachable Machine URL

        // Load Teachable Machine model
        let model;
        async function loadModel() {
            model = await tf.loadLayersModel(modelURL);
            console.log("Model loaded");
        }

        // Function to classify audio
        async function classifyAudio(audioBlob) {
            const audioContext = new AudioContext();
            const arrayBuffer = await audioBlob.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            // Convert audio to spectrogram (example, adjust as needed)
            const spectrogram = convertToSpectrogram(audioBuffer);
            const prediction = await model.predict(spectrogram);
            const result = prediction.argMax(1).dataSync()[0];
            return result;
        }

        // Function to send status to Thunkable
        function sendStatus(status) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(status);
            }
        }

        // Initialize Agora
        client.init(appId, () => {
            console.log("Agora initialized");
            document.getElementById("status").innerText = "Status: Ready";
            loadModel();
        });

        // Start Recording
        function startRecording() {
            try {
                const channelName = "test_channel";
                client.join(null, channelName, null, (uid) => {
                    console.log("User joined with UID:", uid);

                    localStream = AgoraRTC.createStream({ audio: true, video: false });
                    localStream.init(() => {
                        client.publish(localStream);
                        console.log("Recording started");

                        document.getElementById("status").innerText = "Status: Recording";
                        document.getElementById("startBtn").disabled = true;
                        document.getElementById("stopBtn").disabled = false;
                        sendStatus("Recording started");
                    });
                });
            } catch (error) {
                console.error("Error starting recording:", error);
                sendStatus("Error: " + error.message);
            }
        }

        // Stop Recording
        function stopRecording() {
            try {
                client.unpublish(localStream);
                client.leave(() => {
                    localStream.close();
                    console.log("Recording stopped");

                    // Classify the audio using Teachable Machine
                    localStream.getAudioTrack().getBlob().then((audioBlob) => {
                        classifyAudio(audioBlob).then((result) => {
                            sendStatus("Classification: " + result); // Send classification result to Thunkable
                        });
                    });

                    document.getElementById("status").innerText = "Status: Idle";
                    document.getElementById("startBtn").disabled = false;
                    document.getElementById("stopBtn").disabled = true;
                });
            } catch (error) {
                console.error("Error stopping recording:", error);
                sendStatus("Error: " + error.message);
            }
        }

        // Add event listeners for buttons
        document.getElementById("startBtn").addEventListener("click", startRecording);
        document.getElementById("stopBtn").addEventListener("click", stopRecording);

        // Listen for messages from Thunkable
        window.addEventListener('message', (event) => {
            const message = event.data;
            if (message === 'startRecording') {
                startRecording();
            }
            if (message === 'stopRecording') {
                stopRecording();
            }
        });
    </script>
</body>
</html>
