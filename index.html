<script>
    const appId = "25336bcd01664c70870804ba0b7e1b30";
    const modelURL = "https://deanaxelrod.github.io/Google-TM/model.json";
    const classLabels = ["Noise", "Sad Dog", "Excited Dog", "Disappointed Dog", "Growl", "Whimper", "Bark"];

    let mediaRecorder = null;
    let recordedChunks = [];
    let model = null;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('recordingStatus');
    const resultEl = document.getElementById('classificationResult');
    const permissionMsgEl = document.getElementById('permissionMessage');

    function debugLog(message) {
      const debugDiv = document.getElementById('debug');
      const logEntry = document.createElement('p');
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      debugDiv.appendChild(logEntry);
      debugDiv.scrollTop = debugDiv.scrollHeight;
      console.log(message); // Also log to console for additional debugging
    }

    function setRecordingState(recording) {
      startBtn.disabled = recording;
      stopBtn.disabled = !recording;
      statusEl.textContent = `Recording Status: ${recording ? 'Recording' : 'Ready'}`;

      if (recording) {
        stopBtn.classList.add('recording');
      } else {
        stopBtn.classList.remove('recording');
      }
    }

    async function checkMicrophonePermission() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('getUserMedia not supported');
        }

        // Try to query permissions if supported
        if (navigator.permissions) {
          const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
          debugLog(`Microphone Permission Status: ${permissionStatus.state}`);

          permissionStatus.onchange = () => {
            debugLog(`Microphone permission changed to: ${permissionStatus.state}`);
          };

          if (permissionStatus.state === 'denied') {
            permissionMsgEl.textContent = 'Microphone access is blocked. Please enable in device settings.';
            throw new Error('Microphone access denied');
          }
        }

        // Attempt to get user media to verify real-time access
        await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          } 
        });

        permissionMsgEl.textContent = ''; // Clear any previous error messages
        return true;
      } catch (error) {
        debugLog(`Microphone Permission Error: ${error.message}`);
        permissionMsgEl.textContent = `Microphone Access Error: ${error.message}. Please check browser settings.`;
        startBtn.disabled = true;
        return false;
      }
    }

    // ... (rest of the existing script remains the same)

    // Event Listeners
    startBtn.addEventListener('click', async () => {
      try {
        // Ensure this is directly triggered by user interaction
        await checkMicrophonePermission();
        await startRecording();
      } catch (error) {
        debugLog("Recording start error: " + error.message);
      }
    });

    stopBtn.addEventListener('click', stopRecording);

    window.addEventListener('beforeunload', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
    });

    // Initialize on page load
    initialize();
  </script>
